<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Speedpaint Giveaway</title>
  <style type="text/css">
    @import '../common/css/style.css';
  </style>
</head>
<body>

<a id="auth-link" href="#" target="_top"><button id="authorize-btn">Authorize with Twitch</button></a>

<div id="start-giveaway-container">
  <h3>Current Giveaway</h3>
  <input id="giveaway-duration" type="text" placeholder="Giveaway Duration HH:MM" value="" disabled>
  <button id="giveaway-start-btn" disabled>Start Giveaway</button>
</div>

<div id="cancel-giveaway-container">
  <h3>Cancel Giveaway</h3>
  <p id="warning" class="warning hidden">WARNING: This is not undoable!</p>
  <button id="giveaway-cancel-btn" disabled>Cancel Giveaway</button>
  <button id="giveaway-confirm-btn" class="hidden">Are You Sure?!</button>
</div>

<script type="module">
  // Gather the handles on the panel controls, since we're going to need them
  // throughout the code.
  const authLink = document.getElementById('auth-link');
  const authBtn = document.getElementById('authorize-btn');

  const durationFld = document.getElementById('giveaway-duration');
  const startBtn = document.getElementById('giveaway-start-btn');
  const cancelBtn = document.getElementById('giveaway-cancel-btn');
  const warningTxt = document.getElementById('warning');
  const confirmBtn = document.getElementById('giveaway-confirm-btn');

  // Bring in our websocket library and the configuration function
  const getConfig = require('../common/js/config');
  const getWebSocket = require('../common/js/websocket');

  // Information on the currently authorized user (if any) in the overlay
  let currentUser = { authorized: false, userName: undefined } ;

  // The information on the currently running giveaway (if any); when this is
  // undefined, there's not currently a giveaway in progress.
  let currentGiveaway = undefined;

  let toggleID = undefined;
  const confirmToggle = () => {
    [warningTxt, cancelBtn, confirmBtn].forEach(el => el.classList.toggle('hidden'));
    toggleID = undefined;
  }

  // The start button either starts a new giveaway or pauses the existing
  // one, depending on the current state.
  startBtn.addEventListener('click', () => {
    const pause_map = { true: 'unpause', false: 'pause' };

    if (currentGiveaway === undefined) {
      window.fetch('/giveaway/start', { method: 'get' });
    } else {
      window.fetch(`/giveaway/${pause_map[currentGiveaway.paused]}`);
    }
  });

  cancelBtn.addEventListener('click', () => {
    // Flip the state of our confirm buttons; put it back after a few seconds
    confirmToggle();
    toggleID = window.setTimeout(() => confirmToggle(), 5000);
  });

  // The confirm button will confirm; that's why it's called that.
  confirmBtn.addEventListener('click', () => {
    // Flip the button state back; we also need to cancel the confirmation
    // timer.
    window.clearTimeout(toggleID);
    confirmToggle();

    if (currentGiveaway !== undefined) {
      window.fetch('/giveaway/cancel');
    }
  });

  // Alter the panel controls that allow the user to start, pause and stop a
  // giveaway so that they can control things as appropriate.
  //
  // The controls are set up based on the current user (if any) and the current
  // giveaway information (if any).
  function updatePanelControls() {
    // Update the authorization button to take a different action when clicked,
    // which will depend on wether or not there's currently someone authorized.
    authBtn.innerText = currentUser.authorized ? `Deauthorize ${currentUser.userName}` : 'Authorize with Twitch';
    authLink.href = currentUser.authorized ? '/deauth' : '/auth';

    // If there is no current giveaway or there is not currently an authorized
    // user, then all of the controls should be reset to the state that allows
    // the user to start a new giveaway.
    //
    // In the case of there not being a giveaway, we want to start one, and in
    // the case of there being no user, we don't want to display any potentially
    // existing giveaway information.
    if (currentGiveaway === undefined || currentUser.authorized === false) {
      // Allow the user to enter a duration for the giveaway into the field,
      // which should be empty of any previous text.
      durationFld.value = '';
      durationFld.disabled = ! (currentUser.authorized === true);

      // The button should allow us to start a giveaway, but it also requires
      // that the user tpe a valid duration into the input field first, so the
      // button needs to be initially disabled.
      startBtn.innerText = 'Start Giveaway';
      startBtn.disabled = ! (currentUser.authorized === true);

      // Since there's no giveaway running, the button for cancelling it should
      // be disabled.
      cancelBtn.disabled = true;
    } else {
      // When there's a giveaway running (even if it's paused), the duration
      // field is used as an informational field to tell us the current state of
      // things, so set its value as appropriate and disable it so that the user
      // can't type into it.
      durationFld.value = currentGiveaway.paused ? `Giveaway is paused (XX:XX remaining)` : `XX:XX:XX remaining`;
      durationFld.disabled = true;

      // When a giveaway is running, the start button is allowed to pause it.
      startBtn.innerText = currentGiveaway.paused ? 'Resume Giveaway Clock' : 'Pause Giveaway Countdown'
      startBtn.disabled = false;

      // Regardless of wether the currently active giveaway is running or is
      // just paused, the user should be able to cancel it if they want to.
      cancelBtn.disabled = false;
    }
  }

  // Set up all of our handlers and kick the panel off; this will among other
  // things make sure that we're connected to the back end and that we're
  // listening for the appropriate events.
  async function setup() {
    // Get our configuration, and then use it to connect to the back end so
    // that we can communicate with it and get events.
    const config = await getConfig();
    const socket = getWebSocket(location.hostname, config.socketPort);

    // Update the Twitch authorization controls in the panel based on the
    // currently available Twitch authorization state, as transmitted from the
    // back end.
    socket.on("twitch-auth", data => {
      console.log(data);
      currentUser = data;
      updatePanelControls();
    });

    // Receive updates on the current state of the giveaway that's currently in
    // progress, if any. This gets disopatched when the socket first connects
    // too.
    socket.on("giveaway-info", data => {
      console.log(data);
      // Set up the current giveaway, which is either a fully populated object
      // or, if the other end is telling us that there's no giveaway information
      // assume that the value is just undefined.
      currentGiveaway = Object.keys(data).length === 0 ? undefined : data;
      updatePanelControls()
    });

    // Handle an incoming notification of bits and subs being broadcast from the
    // back end.
    socket.on("twitch-bits", data => console.log(data));
    socket.on("twitch-sub", data => console.log(data));

  }

  setup();
</script>
</body>
</html>