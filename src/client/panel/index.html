<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Speedpaint Giveaway</title>
  <style type="text/css">
    @import '../common/css/style.css';
  </style>
</head>
<body>

<a id="auth-link" href="#" target="_top"><button id="authorize-btn">Authorize with Bot Account</button></a>

<script type="module">
  // Bring in our websocket library and the configuration function
  const getConfig = require('../common/js/config');
  const getWebSocket = require('../common/js/websocket');

  // Alter the link and text for the authorize button so that if the user is
  // authorized it will display their name and offer to deauthorize, and
  // otherwise it will invite them to auth themselves.
  function setupAuthButton(authorized, username) {
    const authLink = document.getElementById('auth-link');
    const authBtn = document.getElementById('authorize-btn');

    authBtn.innerText = authorized ? `Deauthorize ${username}` : 'Authorize with Twitch';
    authLink.href = authorized ? '/deauth' : '/auth';
  }

  // By default, assume we're not authorized until we learn differently.
  setupAuthButton(false);

  // Perform our setup actions.
  async function setup() {
    // Get our configuration, and then use it to connect to the back end so
    // that we can communicate with it and get events.
    const config = await getConfig();
    const socket = getWebSocket(location.hostname, config.socketPort);

    // When the twitch authorization state changes, alter the link and text of the
    // button to suit.
    socket.on("twitch-auth", data => {
      setupAuthButton(data.authorized, data.userName);
    });

    socket.on("twitch-bits", data => {
      console.log(data);
    });

    socket.on("twitch-sub", data => {
      console.log(data);
    });

    socket.on("twitch-redeem", data => {
      console.log(data);
    });
  }

  setup();
</script>
</body>
</html>